<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Laberinto Material</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Estilos críticos del juego */
        :root { --bg-color: #050210; --wall-color: #ff00de; --player-color: #00f3ff; --goal-color: #ffe600; }
        body { background-color: var(--bg-color); overflow: hidden; touch-action: none; margin: 0; font-family: sans-serif; }
        #game-container { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        canvas { border-radius: 8px; background: rgba(255,255,255,0.02); box-shadow: 0 0 20px rgba(255,0,222,0.2); max-width: 95%; max-height: 80%; }
        
        /* UI Overlay mejorado */
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .interactive { pointer-events: auto; }
        
        /* Modales */
        .modal { position: absolute; inset: 0; background: rgba(5, 2, 16, 0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 50; text-align: center; }
        .hidden { display: none !important; }
        
        .neon-btn {
            background: transparent; border: 2px solid var(--wall-color); color: white;
            padding: 15px 40px; font-size: 1.2rem; font-weight: bold; cursor: pointer;
            margin-top: 20px; text-transform: uppercase; letter-spacing: 2px;
            transition: 0.3s;
        }
        .neon-btn:active { background: var(--wall-color); }

        /* Botón Salir (Material style) */
        #exit-btn {
            position: absolute; top: 16px; left: 16px; z-index: 100;
            background: rgba(255,255,255,0.1); color: white;
            padding: 8px 16px; border-radius: 20px; text-decoration: none;
            display: flex; align-items: center; gap: 8px; font-size: 14px;
            backdrop-filter: blur(4px); pointer-events: auto;
        }
    </style>
</head>
<body>
    <a href="../index.html" id="exit-btn"><i data-lucide="arrow-left" size="16"></i> Salir</a>

    <div id="game-container">
        <canvas id="mazeCanvas"></canvas>
    </div>

    <div id="start-screen" class="modal interactive">
        <h1 class="text-5xl text-pink-500 font-bold mb-4" style="text-shadow: 0 0 10px #ff00de">NEON MAZE</h1>
        <p class="text-blue-200 mb-8">Encuentra la salida</p>
        <button id="start-btn" class="neon-btn interactive">COMENZAR</button>
    </div>

    <div id="level-modal" class="modal hidden interactive">
        <h2 class="text-3xl text-white mb-2">¡Nivel Completado!</h2>
        <p id="level-msg" class="text-yellow-400 mb-6"></p>
        <button id="next-level-btn" class="neon-btn interactive">Siguiente</button>
    </div>

    <script>
        // --- CONFIGURACIÓN ---
        const LEVELS = [5, 7, 9, 11, 13, 15, 17, 19, 21, 25]; // Tamaños de laberinto
        let state = { level: 0, player: {x:0, y:0}, goal: {x:0, y:0}, maze: [], active: false, cellSize: 0 };
        const canvas = document.getElementById('mazeCanvas');
        const ctx = canvas.getContext('2d');

        // --- INICIO ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            // Cargar progreso local del laberinto (nivel)
            const savedLvl = localStorage.getItem('maze_local_level');
            if(savedLvl) state.level = parseInt(savedLvl);

            // Listeners
            document.getElementById('start-btn').addEventListener('click', startGame);
            document.getElementById('next-level-btn').addEventListener('click', nextLevel);
            
            // Controles
            window.addEventListener('keydown', handleKey);
            setupTouch();
        });

        function startGame() {
            document.getElementById('start-screen').classList.add('hidden');
            loadLevel();
        }

        function loadLevel() {
            const size = LEVELS[state.level % LEVELS.length];
            state.maze = generateMaze(size, size);
            state.player = {x: 0, y: 0};
            state.goal = {x: size-1, y: size-1};
            state.active = true;
            resize();
            draw();
        }

        function nextLevel() {
            state.level++;
            localStorage.setItem('maze_local_level', state.level);
            document.getElementById('level-modal').classList.add('hidden');
            loadLevel();
        }

        // --- INTEGRACIÓN DE MONEDAS (CORE FIX) ---
        function onWin() {
            state.active = false;
            
            // 1. Calcular Recompensa
            const REWARD = 30;
            
            // 2. Comunicar con App.js (Billetera Central)
            let msg = "¡Nivel Superado!";
            try {
                // Leer estado global
                const storeKey = 'gamecenter_material_v1';
                let store = JSON.parse(localStorage.getItem(storeKey) || '{"coins":0,"progress":{"maze":[]}}');
                
                // Verificar progreso
                if(!store.progress) store.progress = {};
                if(!store.progress.maze) store.progress.maze = [];

                if(!store.progress.maze.includes(state.level)) {
                    // PAGO
                    store.progress.maze.push(state.level);
                    store.coins += REWARD;
                    localStorage.setItem(storeKey, JSON.stringify(store));
                    msg += `<br><span style="color:#ffe600; font-size:0.8em">+${REWARD} Monedas (Bono Primera vez)</span>`;
                } else {
                    // REPLAY
                    msg += `<br><span style="color:#aaa; font-size:0.8em">Nivel ya recompensado anteriormente</span>`;
                }
            } catch(e) {
                console.error("Error saving coins", e);
            }

            // 3. Mostrar Modal
            document.getElementById('level-msg').innerHTML = msg;
            document.getElementById('level-modal').classList.remove('hidden');
        }

        // --- LÓGICA JUEGO (Simplificada para funcionamiento) ---
        function generateMaze(cols, rows) {
            let maze = Array(rows).fill().map((_, y) => Array(cols).fill().map((_, x) => ({x, y, walls:{t:1,r:1,b:1,l:1}, visited:false})));
            let stack = [maze[0][0]];
            maze[0][0].visited = true;
            while(stack.length) {
                let curr = stack.pop();
                let n = [[0,-1,'t','b'],[1,0,'r','l'],[0,1,'b','t'],[-1,0,'l','r']]
                    .map(d => ({x:curr.x+d[0], y:curr.y+d[1], w1:d[2], w2:d[3]}))
                    .filter(p => p.x>=0 && p.x<cols && p.y>=0 && p.y<rows && !maze[p.y][p.x].visited);
                if(n.length) {
                    stack.push(curr);
                    let nextPos = n[Math.floor(Math.random()*n.length)];
                    let next = maze[nextPos.y][nextPos.x];
                    curr.walls[nextPos.w1] = 0;
                    next.walls[nextPos.w2] = 0;
                    next.visited = true;
                    stack.push(next);
                }
            }
            return maze;
        }

        function move(dx, dy) {
            if(!state.active) return;
            let c = state.maze[state.player.y][state.player.x];
            if(dy === -1 && !c.walls.t) state.player.y--;
            else if(dx === 1 && !c.walls.r) state.player.x++;
            else if(dy === 1 && !c.walls.b) state.player.y++;
            else if(dx === -1 && !c.walls.l) state.player.x--;
            else return; // Pared
            draw();
            if(state.player.x === state.goal.x && state.player.y === state.goal.y) onWin();
        }

        function draw() {
            if(!state.maze.length) return;
            ctx.fillStyle = '#050210'; ctx.fillRect(0,0,canvas.width,canvas.height);
            let cs = state.cellSize;
            ctx.strokeStyle = '#ff00de'; ctx.lineWidth = 2; ctx.lineCap = 'round';
            ctx.beginPath();
            state.maze.forEach(row => row.forEach(c => {
                let x=c.x*cs, y=c.y*cs;
                if(c.walls.t) {ctx.moveTo(x,y); ctx.lineTo(x+cs,y);}
                if(c.walls.r) {ctx.moveTo(x+cs,y); ctx.lineTo(x+cs,y+cs);}
                if(c.walls.b) {ctx.moveTo(x,y+cs); ctx.lineTo(x+cs,y+cs);}
                if(c.walls.l) {ctx.moveTo(x,y+cs); ctx.lineTo(x,y);}
            }));
            ctx.stroke();
            // Jugador
            ctx.fillStyle = '#00f3ff';
            ctx.beginPath(); ctx.arc(state.player.x*cs+cs/2, state.player.y*cs+cs/2, cs/3, 0, 7); ctx.fill();
            // Meta
            ctx.fillStyle = '#ffe600';
            ctx.fillRect(state.goal.x*cs+cs/4, state.goal.y*cs+cs/4, cs/2, cs/2);
        }

        function resize() {
            let s = Math.min(window.innerWidth, window.innerHeight) - 40;
            let cols = state.maze[0]?.length || 5;
            state.cellSize = Math.floor(s / cols);
            canvas.width = state.cellSize * cols;
            canvas.height = canvas.width;
            draw();
        }
        window.addEventListener('resize', resize);

        function handleKey(e) {
            if(e.key.startsWith('Arrow')) e.preventDefault();
            if(e.key === 'ArrowUp') move(0,-1);
            if(e.key === 'ArrowDown') move(0,1);
            if(e.key === 'ArrowLeft') move(-1,0);
            if(e.key === 'ArrowRight') move(1,0);
        }

        function setupTouch() {
            let tx=0, ty=0;
            canvas.addEventListener('touchstart', e => {tx=e.touches[0].clientX; ty=e.touches[0].clientY;}, {passive:false});
            canvas.addEventListener('touchmove', e => e.preventDefault(), {passive:false});
            canvas.addEventListener('touchend', e => {
                let dx = e.changedTouches[0].clientX - tx;
                let dy = e.changedTouches[0].clientY - ty;
                if(Math.abs(dx) > Math.abs(dy)) move(dx>0?1:-1, 0);
                else move(0, dy>0?1:-1);
            });
        }
    </script>
</body>
</html>
